name: CI/CD Build Check

on:
  push:
    branches: [ main, develop, '20*' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: [8, 11, 17]
        os: [ubuntu-latest, windows-latest, macos-latest]
      fail-fast: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Validate Maven structure
      run: mvn validate

    - name: Compile project
      run: mvn clean compile -B -V

    - name: Run tests (if enabled)
      run: mvn test -B
      continue-on-error: true

    - name: Package application
      run: mvn package -DskipTests -B

    - name: Verify packaging
      run: |
        echo "Checking built artifacts..."
        find . -name "*.jar" -type f | grep -v ".m2" | head -10

    - name: Upload build artifacts
      if: matrix.java-version == '8' && matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: maven-artifacts
        path: |
          **/target/*.jar
          **/target/classes/
        retention-days: 7

  dependency-check:
    name: Dependency Analysis
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Analyze dependencies
      run: mvn dependency:tree -B

    - name: Check for dependency conflicts
      run: mvn dependency:analyze -B

    - name: Generate dependency report
      run: |
        mvn dependency:list -DoutputFile=dependencies.txt -B
        echo "Dependencies report generated"

    - name: Upload dependency report
      uses: actions/upload-artifact@v4
      with:
        name: dependency-report
        path: dependencies.txt
        retention-days: 7

  build-info:
    name: Build Information
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate build info
      run: |
        echo "Build Information:" > build-info.txt
        echo "==================" >> build-info.txt
        echo "Repository: ${{ github.repository }}" >> build-info.txt
        echo "Branch: ${{ github.ref_name }}" >> build-info.txt
        echo "Commit: ${{ github.sha }}" >> build-info.txt
        echo "Build Time: $(date)" >> build-info.txt
        echo "Event: ${{ github.event_name }}" >> build-info.txt
        echo "" >> build-info.txt
        echo "Project Structure:" >> build-info.txt
        find . -name "pom.xml" | grep -v target | sort >> build-info.txt

    - name: Display build info
      run: cat build-info.txt

    - name: Upload build info
      uses: actions/upload-artifact@v4
      with:
        name: build-info
        path: build-info.txt
        retention-days: 30
