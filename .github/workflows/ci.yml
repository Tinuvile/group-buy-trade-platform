name: CI/CD Build Check

on:
  push:
    branches: [ main, develop, '20*' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: [8, 11, 17]
        os: [ubuntu-latest, windows-latest, macos-latest]
      fail-fast: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Validate Maven structure
      run: mvn validate

    - name: Compile project
      run: mvn clean compile -B -V

    - name: Run tests (if enabled)
      run: mvn test -B
      continue-on-error: true

    - name: Package application
      run: mvn package -DskipTests -B

    - name: Install to local repository
      run: mvn install -DskipTests -B

    - name: Verify packaging
      run: |
        echo "Checking built artifacts..."
        find . -name "*.jar" -type f | grep -v ".m2" | head -10

    - name: Upload build artifacts
      if: matrix.java-version == '8' && matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: maven-artifacts
        path: |
          **/target/*.jar
          **/target/classes/
        retention-days: 7

  dependency-check:
    name: Dependency Analysis
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Verify internal modules availability
      run: |
        echo "# Dependency Analysis Preparation" > dependency-check-report.md
        echo "" >> dependency-check-report.md
        echo "Generated on: $(date)" >> dependency-check-report.md
        echo "" >> dependency-check-report.md
        
        # Check if internal modules are available in local repository
        echo "## Internal Module Verification" >> dependency-check-report.md
        echo "" >> dependency-check-report.md
        
        INTERNAL_MODULES="group-buy-trade-platform-types group-buy-trade-platform-api group-buy-trade-platform-domain group-buy-trade-platform-infrastructure group-buy-trade-platform-trigger"
        MISSING_MODULES=0
        
        for module in $INTERNAL_MODULES; do
          if ls ~/.m2/repository/com/tinuvile/$module/1.0-SNAPSHOT/$module-1.0-SNAPSHOT.jar >/dev/null 2>&1; then
            echo "- ✅ **$module**: Available in local repository" >> dependency-check-report.md
          else
            echo "- ❌ **$module**: Missing from local repository" >> dependency-check-report.md
            MISSING_MODULES=$((MISSING_MODULES + 1))
          fi
        done
        
        echo "" >> dependency-check-report.md
        echo "**Missing modules count**: $MISSING_MODULES" >> dependency-check-report.md
        echo "" >> dependency-check-report.md
        
        if [ $MISSING_MODULES -gt 0 ]; then
          echo "⚠️ Warning: Some internal modules are missing, attempting to rebuild..."
          mvn clean install -DskipTests -B -q || {
            echo "❌ **Status**: Failed to rebuild missing modules" >> dependency-check-report.md
            exit 1
          }
          echo "✅ **Status**: Successfully rebuilt missing modules" >> dependency-check-report.md
        else
          echo "✅ **Status**: All internal modules are available" >> dependency-check-report.md
        fi

    - name: Analyze dependencies
      run: |
        echo "## Dependency Tree Analysis" >> dependency-check-report.md
        echo "" >> dependency-check-report.md
        
        if mvn dependency:tree -B > dependency-tree.txt 2>&1; then
          echo "✅ **Status**: Dependency tree analysis completed" >> dependency-check-report.md
          echo "" >> dependency-check-report.md
          echo "### Dependency Tree Summary" >> dependency-check-report.md
          echo "\`\`\`" >> dependency-check-report.md
          head -20 dependency-tree.txt >> dependency-check-report.md
          echo "\`\`\`" >> dependency-check-report.md
        else
          echo "❌ **Status**: Dependency tree analysis failed" >> dependency-check-report.md
          echo "" >> dependency-check-report.md
          echo "### Error Details" >> dependency-check-report.md
          echo "\`\`\`" >> dependency-check-report.md
          tail -10 dependency-tree.txt >> dependency-check-report.md
          echo "\`\`\`" >> dependency-check-report.md
        fi

    - name: Check for dependency conflicts
      run: |
        echo "" >> dependency-check-report.md
        echo "## Dependency Conflict Analysis" >> dependency-check-report.md
        echo "" >> dependency-check-report.md
        
        if mvn dependency:analyze -B > dependency-analyze.txt 2>&1; then
          echo "✅ **Status**: Dependency conflict analysis completed" >> dependency-check-report.md
          
          # Check for warnings in the output
          if grep -qi "warning\|unused\|undeclared" dependency-analyze.txt; then
            echo "⚠️ **Warnings Found**: Some dependency issues detected" >> dependency-check-report.md
            echo "" >> dependency-check-report.md
            echo "### Dependency Warnings" >> dependency-check-report.md
            echo "\`\`\`" >> dependency-check-report.md
            grep -i "warning\|unused\|undeclared" dependency-analyze.txt | head -10 >> dependency-check-report.md
            echo "\`\`\`" >> dependency-check-report.md
          else
            echo "✅ **Result**: No dependency conflicts detected" >> dependency-check-report.md
          fi
        else
          echo "❌ **Status**: Dependency conflict analysis failed" >> dependency-check-report.md
        fi

    - name: Generate dependency report
      run: |
        echo "" >> dependency-check-report.md
        echo "## Dependency List Generation" >> dependency-check-report.md
        echo "" >> dependency-check-report.md
        
        if mvn dependency:list -DoutputFile=dependencies.txt -B > dependency-list.txt 2>&1; then
          echo "✅ **Status**: Dependency list generated successfully" >> dependency-check-report.md
          
          # Count dependencies
          if [ -f dependencies.txt ]; then
            TOTAL_DEPS=$(wc -l < dependencies.txt)
            echo "- **Total Dependencies**: $TOTAL_DEPS" >> dependency-check-report.md
            echo "Dependencies report generated"
          else
            echo "⚠️ **Warning**: dependencies.txt not found" >> dependency-check-report.md
          fi
        else
          echo "❌ **Status**: Failed to generate dependency list" >> dependency-check-report.md
          echo "" >> dependency-check-report.md
          echo "### Error Details" >> dependency-check-report.md
          echo "\`\`\`" >> dependency-check-report.md
          tail -10 dependency-list.txt >> dependency-check-report.md
          echo "\`\`\`" >> dependency-check-report.md
          exit 1
        fi

    - name: Upload dependency report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dependency-report
        path: |
          dependency-check-report.md
          dependencies.txt
          dependency-tree.txt
          dependency-analyze.txt
          dependency-list.txt
        retention-days: 7

  build-info:
    name: Build Information
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate build info
      run: |
        echo "Build Information:" > build-info.txt
        echo "==================" >> build-info.txt
        echo "Repository: ${{ github.repository }}" >> build-info.txt
        echo "Branch: ${{ github.ref_name }}" >> build-info.txt
        echo "Commit: ${{ github.sha }}" >> build-info.txt
        echo "Build Time: $(date)" >> build-info.txt
        echo "Event: ${{ github.event_name }}" >> build-info.txt
        echo "" >> build-info.txt
        echo "Project Structure:" >> build-info.txt
        find . -name "pom.xml" | grep -v target | sort >> build-info.txt

    - name: Display build info
      run: cat build-info.txt

    - name: Upload build info
      uses: actions/upload-artifact@v4
      with:
        name: build-info
        path: build-info.txt
        retention-days: 30
