name: Code Style Analysis

on:
  push:
    branches: [ main, develop, '20*' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  pmd-analysis:
    name: PMD Static Code Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Create PMD ruleset
      run: |
        mkdir -p .github/pmd
        cat > .github/pmd/ruleset.xml << 'EOF'
        <?xml version="1.0"?>
        <ruleset name="Group Buy Trade Platform Rules"
                 xmlns="http://pmd.sourceforge.net/ruleset/2.0.0"
                 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                 xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/2.0.0 https://pmd.sourceforge.io/ruleset_2_0_0.xsd">
            <description>PMD Rules for Group Buy Trade Platform</description>
            
            <!-- Best Practices -->
            <rule ref="category/java/bestpractices.xml">
                <exclude name="JUnitTestsShouldIncludeAssert"/>
                <exclude name="JUnitAssertionsShouldIncludeMessage"/>
                <exclude name="GuardLogStatement"/>
            </rule>
            
            <!-- Code Style -->
            <rule ref="category/java/codestyle.xml">
                <exclude name="OnlyOneReturn"/>
                <exclude name="AtLeastOneConstructor"/>
                <exclude name="CallSuperInConstructor"/>
                <exclude name="CommentDefaultAccessModifier"/>
                <exclude name="DefaultPackage"/>
                <exclude name="EmptyMethodInAbstractClassShouldBeAbstract"/>
                <exclude name="LongVariable"/>
                <exclude name="ShortVariable"/>
                <exclude name="ShortClassName"/>
                <exclude name="ShortMethodName"/>
                <exclude name="TooManyStaticImports"/>
                <exclude name="UnnecessaryAnnotationValueElement"/>
                <exclude name="UnnecessaryLocalBeforeReturn"/>
                <exclude name="UselessParentheses"/>
            </rule>
            
            <!-- Design -->
            <rule ref="category/java/design.xml">
                <exclude name="LawOfDemeter"/>
                <exclude name="LoosePackageCoupling"/>
                <exclude name="UseUtilityClass"/>
            </rule>
            
            <!-- Error Prone -->
            <rule ref="category/java/errorprone.xml">
                <exclude name="BeanMembersShouldSerialize"/>
                <exclude name="DataflowAnomalyAnalysis"/>
                <exclude name="NullAssignment"/>
            </rule>
            
            <!-- Performance -->
            <rule ref="category/java/performance.xml"/>
            
            <!-- Security -->
            <rule ref="category/java/security.xml"/>
            
            <!-- Custom Rules -->
            <rule ref="category/java/codestyle.xml/ClassNamingConventions">
                <properties>
                    <property name="classPattern" value="[A-Z][a-zA-Z0-9]*"/>
                    <property name="abstractClassPattern" value="Abstract[A-Z][a-zA-Z0-9]*"/>
                    <property name="interfacePattern" value="I[A-Z][a-zA-Z0-9]*"/>
                    <property name="enumPattern" value="[A-Z][a-zA-Z0-9]*"/>
                    <property name="annotationPattern" value="[A-Z][a-zA-Z0-9]*"/>
                    <property name="utilityClassPattern" value="[A-Z][a-zA-Z0-9]*Utils?"/>
                </properties>
            </rule>
            
            <rule ref="category/java/design.xml/TooManyMethods">
                <properties>
                    <property name="maxmethods" value="25"/>
                </properties>
            </rule>
            
            <rule ref="category/java/design.xml/TooManyFields">
                <properties>
                    <property name="maxfields" value="20"/>
                </properties>
            </rule>
            
            <rule ref="category/java/design.xml/CyclomaticComplexity">
                <properties>
                    <property name="classReportLevel" value="80"/>
                    <property name="methodReportLevel" value="10"/>
                </properties>
            </rule>
        </ruleset>
        EOF

    - name: Download PMD
      run: |
        wget -O pmd.zip https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.0.0/pmd-dist-7.0.0-bin.zip
        unzip -q pmd.zip
        mv pmd-bin-7.0.0 pmd

    - name: Run PMD analysis
      run: |
        # Find source directories
        SOURCE_DIRS=$(find . -type d -name "java" -path "*/src/main/*" | tr '\n' ',' | sed 's/,$//')
        
        if [ -n "$SOURCE_DIRS" ]; then
          echo "Running PMD analysis on: $SOURCE_DIRS"
          ./pmd/bin/pmd check \
            --dir "$SOURCE_DIRS" \
            --rulesets .github/pmd/ruleset.xml \
            --format text \
            --report-file pmd-report.txt \
            --minimum-priority 3 \
            --fail-on-violation false || true
            
          # Also generate HTML report
          ./pmd/bin/pmd check \
            --dir "$SOURCE_DIRS" \
            --rulesets .github/pmd/ruleset.xml \
            --format html \
            --report-file pmd-report.html \
            --minimum-priority 3 \
            --fail-on-violation false || true
        else
          echo "No Java source directories found"
        fi

    - name: Process PMD results
      run: |
        if [ -f pmd-report.txt ] && [ -s pmd-report.txt ]; then
          echo "PMD violations found:"
          cat pmd-report.txt
          
          # Count violations
          VIOLATION_COUNT=$(grep -c ":" pmd-report.txt || echo "0")
          echo "Total violations: $VIOLATION_COUNT"
          
          if [ "$VIOLATION_COUNT" -gt 50 ]; then
            echo "❌ Too many PMD violations ($VIOLATION_COUNT > 50)"
            exit 1
          elif [ "$VIOLATION_COUNT" -gt 0 ]; then
            echo "⚠️  PMD violations found ($VIOLATION_COUNT), but within acceptable range"
          else
            echo "✅ No PMD violations found"
          fi
        else
          echo "✅ No PMD violations found"
        fi

    - name: Upload PMD reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pmd-reports
        path: |
          pmd-report.txt
          pmd-report.html
          .github/pmd/ruleset.xml
        retention-days: 7

  spotbugs-analysis:
    name: SpotBugs Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Compile project
      run: mvn clean compile -B -DskipTests

    - name: Add SpotBugs plugin configuration
      run: |
        # Create SpotBugs configuration
        cat > spotbugs-config.xml << 'EOF'
        <plugin>
          <groupId>com.github.spotbugs</groupId>
          <artifactId>spotbugs-maven-plugin</artifactId>
          <version>4.8.2.0</version>
          <configuration>
            <effort>Max</effort>
            <threshold>Low</threshold>
            <failOnError>false</failOnError>
            <includeFilterFile>${project.basedir}/.github/spotbugs/include.xml</includeFilterFile>
            <excludeFilterFile>${project.basedir}/.github/spotbugs/exclude.xml</excludeFilterFile>
            <xmlOutput>true</xmlOutput>
            <htmlOutput>true</htmlOutput>
          </configuration>
          <executions>
            <execution>
              <goals>
                <goal>check</goal>
              </goals>
            </execution>
          </executions>
        </plugin>
        EOF

    - name: Create SpotBugs filters
      run: |
        mkdir -p .github/spotbugs
        
        # Include filter (what to check)
        cat > .github/spotbugs/include.xml << 'EOF'
        <FindBugsFilter>
          <Match>
            <Package name="com.tinuvile.*"/>
          </Match>
        </FindBugsFilter>
        EOF
        
        # Exclude filter (what to ignore)
        cat > .github/spotbugs/exclude.xml << 'EOF'
        <FindBugsFilter>
          <!-- Exclude test files -->
          <Match>
            <Class name="~.*\.test\..*"/>
          </Match>
          
          <!-- Exclude generated files -->
          <Match>
            <Class name="~.*\.target\..*"/>
          </Match>
          
          <!-- Exclude specific bugs that are false positives -->
          <Match>
            <Bug pattern="SE_BAD_FIELD"/>
            <Class name="~.*Dto$"/>
          </Match>
          
          <Match>
            <Bug pattern="EI_EXPOSE_REP,EI_EXPOSE_REP2"/>
            <Class name="~.*Config.*"/>
          </Match>
        </FindBugsFilter>
        EOF

    - name: Run SpotBugs analysis
      run: |
        # Insert SpotBugs plugin to parent POM
        if [ -f pom.xml ]; then
          sed -i '/<\/plugins>/i\
        '"$(cat spotbugs-config.xml | sed 's/$/\\/' | tr -d '\n' | sed 's/\\$//')" pom.xml
          
          # Run SpotBugs
          mvn spotbugs:check -B || true
          
          # Generate reports
          mvn spotbugs:spotbugs -B || true
        fi

    - name: Process SpotBugs results
      run: |
        # Find SpotBugs XML reports
        find . -name "spotbugsXml.xml" -path "*/target/*" | while read report; do
          if [ -f "$report" ]; then
            echo "Processing SpotBugs report: $report"
            
            # Count bugs
            BUG_COUNT=$(grep -c "<BugInstance" "$report" 2>/dev/null || echo "0")
            echo "Bugs found in $report: $BUG_COUNT"
            
            # Extract bug summaries
            if [ "$BUG_COUNT" -gt 0 ]; then
              echo "Bug details:"
              grep -A 5 "<BugInstance" "$report" | head -20 || true
            fi
          fi
        done
        
        # Check if any critical issues found
        TOTAL_BUGS=$(find . -name "spotbugsXml.xml" -path "*/target/*" -exec grep -c "<BugInstance" {} + 2>/dev/null | awk '{sum+=$1} END {print sum+0}')
        echo "Total bugs across all modules: $TOTAL_BUGS"
        
        if [ "$TOTAL_BUGS" -gt 20 ]; then
          echo "❌ Too many SpotBugs violations ($TOTAL_BUGS > 20)"
          exit 1
        elif [ "$TOTAL_BUGS" -gt 0 ]; then
          echo "⚠️  SpotBugs violations found ($TOTAL_BUGS), but within acceptable range"
        else
          echo "✅ No SpotBugs violations found"
        fi

    - name: Upload SpotBugs reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: spotbugs-reports
        path: |
          **/target/spotbugs*.xml
          **/target/spotbugs*.html
          .github/spotbugs/
        retention-days: 7

  complexity-analysis:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Install complexity analysis tools
      run: |
        # Install lizard for complexity analysis
        pip install lizard

    - name: Run complexity analysis
      run: |
        echo "# Code Complexity Analysis Report" > complexity-report.md
        echo "" >> complexity-report.md
        
        # Analyze Java files
        find . -name "*.java" -not -path "./target/*" -not -path "./.m2/*" > java-files.txt
        
        if [ -s java-files.txt ]; then
          echo "Running complexity analysis..."
          
          # Run lizard analysis
          lizard $(cat java-files.txt) -l java -w -C 15 -L 30 > lizard-output.txt || true
          
          # Process results
          echo "## Complexity Summary" >> complexity-report.md
          echo "" >> complexity-report.md
          echo "\`\`\`" >> complexity-report.md
          head -20 lizard-output.txt >> complexity-report.md
          echo "\`\`\`" >> complexity-report.md
          echo "" >> complexity-report.md
          
          # Find complex functions
          echo "## High Complexity Functions (>15)" >> complexity-report.md
          echo "" >> complexity-report.md
          grep -E "^\s*[0-9]+\s+[0-9]+\s+1[5-9]|^\s*[0-9]+\s+[0-9]+\s+[2-9][0-9]" lizard-output.txt | head -10 >> complexity-report.md || echo "No highly complex functions found" >> complexity-report.md
          
          # Count violations
          HIGH_COMPLEXITY_COUNT=$(grep -cE "^\s*[0-9]+\s+[0-9]+\s+1[5-9]|^\s*[0-9]+\s+[0-9]+\s+[2-9][0-9]" lizard-output.txt || echo "0")
          
          echo "" >> complexity-report.md
          echo "**Total high complexity functions: $HIGH_COMPLEXITY_COUNT**" >> complexity-report.md
          
          if [ "$HIGH_COMPLEXITY_COUNT" -gt 10 ]; then
            echo "❌ Too many high complexity functions ($HIGH_COMPLEXITY_COUNT > 10)"
            exit 1
          elif [ "$HIGH_COMPLEXITY_COUNT" -gt 0 ]; then
            echo "⚠️  High complexity functions found ($HIGH_COMPLEXITY_COUNT), but within acceptable range"
          else
            echo "✅ No high complexity functions found"
          fi
        else
          echo "No Java files found for complexity analysis"
        fi

    - name: Upload complexity report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: complexity-report
        path: |
          complexity-report.md
          lizard-output.txt
        retention-days: 7

  code-duplication:
    name: Code Duplication Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Install CPD (Copy-Paste Detector)
      run: |
        # Download PMD (which includes CPD)
        wget -O pmd.zip https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.0.0/pmd-dist-7.0.0-bin.zip
        unzip -q pmd.zip
        mv pmd-bin-7.0.0 pmd

    - name: Run CPD analysis
      run: |
        # Find source directories
        SOURCE_DIRS=$(find . -type d -name "java" -path "*/src/main/*")
        
        if [ -n "$SOURCE_DIRS" ]; then
          echo "Running CPD analysis..."
          
          # Run CPD with minimum token length of 50
          ./pmd/bin/cpd \
            --minimum-tokens 50 \
            --language java \
            --dir $(echo $SOURCE_DIRS | tr ' ' ',') \
            --format text > cpd-report.txt || true
            
          # Also generate XML format
          ./pmd/bin/cpd \
            --minimum-tokens 50 \
            --language java \
            --dir $(echo $SOURCE_DIRS | tr ' ' ',') \
            --format xml > cpd-report.xml || true
          
          # Process results
          if [ -f cpd-report.txt ] && [ -s cpd-report.txt ]; then
            DUPLICATION_COUNT=$(grep -c "Found a" cpd-report.txt || echo "0")
            echo "Code duplications found: $DUPLICATION_COUNT"
            
            if [ "$DUPLICATION_COUNT" -gt 5 ]; then
              echo "❌ Too many code duplications ($DUPLICATION_COUNT > 5)"
              echo "First few duplications:"
              head -50 cpd-report.txt
              exit 1
            elif [ "$DUPLICATION_COUNT" -gt 0 ]; then
              echo "⚠️  Code duplications found ($DUPLICATION_COUNT), but within acceptable range"
              echo "Duplications:"
              cat cpd-report.txt
            else
              echo "✅ No significant code duplication found"
            fi
          else
            echo "✅ No code duplication found"
          fi
        else
          echo "No Java source directories found"
        fi

    - name: Upload CPD report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cpd-reports
        path: |
          cpd-report.txt
          cpd-report.xml
        retention-days: 7

  summary:
    name: Code Style Summary
    runs-on: ubuntu-latest
    needs: [pmd-analysis, spotbugs-analysis, complexity-analysis, code-duplication]
    if: always()

    steps:
    - name: Download all reports
      uses: actions/download-artifact@v4

    - name: Generate summary report
      run: |
        echo "# Code Style Analysis Summary" > style-summary.md
        echo "" >> style-summary.md
        echo "Generated on: $(date)" >> style-summary.md
        echo "" >> style-summary.md
        
        # PMD Summary
        echo "## PMD Analysis" >> style-summary.md
        if [ -f pmd-reports/pmd-report.txt ]; then
          PMD_COUNT=$(grep -c ":" pmd-reports/pmd-report.txt || echo "0")
          echo "- **Violations found**: $PMD_COUNT" >> style-summary.md
        else
          echo "- **Status**: No violations found ✅" >> style-summary.md
        fi
        echo "" >> style-summary.md
        
        # SpotBugs Summary
        echo "## SpotBugs Analysis" >> style-summary.md
        SPOTBUGS_COUNT=0
        if [ -d spotbugs-reports ]; then
          SPOTBUGS_COUNT=$(find spotbugs-reports -name "*.xml" -exec grep -c "<BugInstance" {} + 2>/dev/null | awk '{sum+=$1} END {print sum+0}')
        fi
        echo "- **Bugs found**: $SPOTBUGS_COUNT" >> style-summary.md
        echo "" >> style-summary.md
        
        # Complexity Summary
        echo "## Complexity Analysis" >> style-summary.md
        if [ -f complexity-report/lizard-output.txt ]; then
          COMPLEX_COUNT=$(grep -cE "^\s*[0-9]+\s+[0-9]+\s+1[5-9]|^\s*[0-9]+\s+[0-9]+\s+[2-9][0-9]" complexity-report/lizard-output.txt || echo "0")
          echo "- **High complexity functions**: $COMPLEX_COUNT" >> style-summary.md
        else
          echo "- **Status**: Analysis completed ✅" >> style-summary.md
        fi
        echo "" >> style-summary.md
        
        # Duplication Summary
        echo "## Code Duplication" >> style-summary.md
        if [ -f cpd-reports/cpd-report.txt ]; then
          DUP_COUNT=$(grep -c "Found a" cpd-reports/cpd-report.txt || echo "0")
          echo "- **Duplications found**: $DUP_COUNT" >> style-summary.md
        else
          echo "- **Status**: No duplications found ✅" >> style-summary.md
        fi
        echo "" >> style-summary.md
        
        # Overall Status
        TOTAL_ISSUES=$((PMD_COUNT + SPOTBUGS_COUNT + COMPLEX_COUNT + DUP_COUNT))
        echo "## Overall Status" >> style-summary.md
        echo "- **Total issues**: $TOTAL_ISSUES" >> style-summary.md
        
        if [ "$TOTAL_ISSUES" -eq 0 ]; then
          echo "- **Result**: ✅ All checks passed!" >> style-summary.md
        elif [ "$TOTAL_ISSUES" -lt 20 ]; then
          echo "- **Result**: ⚠️  Minor issues found, within acceptable range" >> style-summary.md
        else
          echo "- **Result**: ❌ Significant issues found, requires attention" >> style-summary.md
        fi

    - name: Upload summary report
      uses: actions/upload-artifact@v4
      with:
        name: code-style-summary
        path: style-summary.md
        retention-days: 30
