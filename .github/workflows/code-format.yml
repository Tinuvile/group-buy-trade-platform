name: Java Code Format Check

on:
  push:
    branches: [ main, develop, '20*' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  format-check:
    name: Code Format Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Check Google Java Format
      run: |
        # Download Google Java Format (Java 8 compatible version)
        wget -O google-java-format.jar https://github.com/google/google-java-format/releases/download/v1.15.0/google-java-format-1.15.0-all-deps.jar
        
        # Find all Java files
        find . -name "*.java" -not -path "./target/*" -not -path "./.m2/*" > java-files.txt
        
        # Check format
        echo "# Google Java Format Report" > format-check-report.md
        echo "" >> format-check-report.md
        echo "Generated on: $(date)" >> format-check-report.md
        echo "" >> format-check-report.md
        
        if [ -s java-files.txt ]; then
          JAVA_FILE_COUNT=$(wc -l < java-files.txt)
          echo "## Files Checked" >> format-check-report.md
          echo "- **Total Java files**: $JAVA_FILE_COUNT" >> format-check-report.md
          echo "" >> format-check-report.md
          
          echo "Checking Java code format..."
          if java -jar google-java-format.jar --dry-run --set-exit-if-changed $(cat java-files.txt); then
            echo "‚úÖ All Java files are properly formatted"
            echo "## Format Check Results" >> format-check-report.md
            echo "‚úÖ **Status**: All files are properly formatted" >> format-check-report.md
          else
            echo "‚ùå Code format issues found!"
            echo "## Format Check Results" >> format-check-report.md
            echo "‚ùå **Status**: Some files need formatting" >> format-check-report.md
            echo "" >> format-check-report.md
            echo "### Files that need formatting:" >> format-check-report.md
            
            # Check each file individually to identify which ones need formatting
            while read -r file; do
              if ! java -jar google-java-format.jar --dry-run --set-exit-if-changed "$file" >/dev/null 2>&1; then
                echo "- \`$file\`" >> format-check-report.md
              fi
            done < java-files.txt
            
            echo "" >> format-check-report.md
            echo "### How to fix:" >> format-check-report.md
            echo "1. Run \`git commit -m 'fix: code formatting [auto-format]'\` to trigger auto-formatting" >> format-check-report.md
            echo "2. Or manually run Google Java Format on these files" >> format-check-report.md
            exit 1
          fi
        else
          echo "No Java files found to check"
          echo "## Files Checked" >> format-check-report.md
          echo "‚ö†Ô∏è **Warning**: No Java files found in the project" >> format-check-report.md
        fi

    - name: Upload format report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: google-java-format-report
        path: |
          format-check-report.md
          java-files.txt
        retention-days: 7

  spotless-check:
    name: Spotless Format Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Add Spotless plugin to parent POM
      run: |
        # Create a temporary POM with Spotless configuration
        cat > spotless-config.xml << 'EOF'
        <plugin>
          <groupId>com.diffplug.spotless</groupId>
          <artifactId>spotless-maven-plugin</artifactId>
          <version>2.43.0</version>
          <configuration>
            <java>
              <includes>
                <include>src/main/java/**/*.java</include>
                <include>src/test/java/**/*.java</include>
              </includes>
              <googleJavaFormat>
                <version>1.15.0</version>
                <style>GOOGLE</style>
              </googleJavaFormat>
              <removeUnusedImports/>
              <trimTrailingWhitespace/>
              <endWithNewline/>
            </java>
            <pom>
              <includes>
                <include>pom.xml</include>
                <include>*/pom.xml</include>
              </includes>
              <sortPom>
                <encoding>UTF-8</encoding>
                <lineSeparator>\n</lineSeparator>
                <expandEmptyElements>true</expandEmptyElements>
                <spaceBeforeCloseEmptyElement>false</spaceBeforeCloseEmptyElement>
                <keepBlankLines>true</keepBlankLines>
                <nrOfIndentSpace>4</nrOfIndentSpace>
              </sortPom>
            </pom>
          </configuration>
          <executions>
            <execution>
              <goals>
                <goal>check</goal>
              </goals>
            </execution>
          </executions>
        </plugin>
        EOF

    - name: Check with Spotless
      run: |
        echo "# Spotless Format Check Report" > spotless-report.md
        echo "" >> spotless-report.md
        echo "Generated on: $(date)" >> spotless-report.md
        echo "" >> spotless-report.md
        
        # Create a temporary POM with Spotless plugin
        if [ -f pom.xml ]; then
          # Backup original POM
          cp pom.xml pom.xml.backup
          
          # Check if plugins section exists
          if grep -q "<plugins>" pom.xml; then
            # Insert plugin before closing </plugins> tag
            sed -i '/<\/plugins>/i\
        '"$(cat spotless-config.xml | sed 's/&/\\\&/g')" pom.xml
            
            echo "## Spotless Plugin Configuration" >> spotless-report.md
            echo "- **Status**: Plugin added to POM temporarily" >> spotless-report.md
            echo "" >> spotless-report.md
            
            # Run spotless check
            echo "## Format Check Results" >> spotless-report.md
            if mvn spotless:check -B -q; then
              echo "‚úÖ **Result**: All files are properly formatted" >> spotless-report.md
              echo "‚úÖ Spotless format check passed"
            else
              echo "‚ö†Ô∏è **Result**: Some files need formatting" >> spotless-report.md
              echo "‚ö†Ô∏è Spotless format check found issues - continuing with warning"
            fi
          else
            echo "‚ö†Ô∏è **Warning**: No <plugins> section found in POM" >> spotless-report.md
            echo "‚ö†Ô∏è No plugins section found, skipping Spotless check"
          fi
          
          # Restore original POM
          mv pom.xml.backup pom.xml
        else
          echo "‚ùå **Error**: No pom.xml found" >> spotless-report.md
        fi
      continue-on-error: true

    - name: Upload Spotless report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: spotless-report
        path: |
          spotless-report.md
          spotless-config.xml
        retention-days: 7

  auto-format:
    name: Auto Format (Create PR)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && contains(github.event.head_commit.message, '[auto-format]')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Format code with Google Java Format
      run: |
        # Download Google Java Format (Java 8 compatible version)
        wget -O google-java-format.jar https://github.com/google/google-java-format/releases/download/v1.15.0/google-java-format-1.15.0-all-deps.jar
        
        # Format all Java files
        find . -name "*.java" -not -path "./target/*" -not -path "./.m2/*" -exec java -jar google-java-format.jar --replace {} \;

    - name: Check for changes
      id: changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
        else
          echo "changes=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Pull Request
      if: steps.changes.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'style: auto-format Java code with Google Java Format'
        title: 'üé® Auto-format Java code'
        body: |
          ## Auto-formatting applied
          
          This PR was automatically created to apply code formatting using Google Java Format.
          
          ### Changes:
          - Applied Google Java Format to all Java files
          - Removed unused imports where applicable
          - Fixed indentation and spacing
          
          Please review and merge if the formatting looks correct.
        branch: auto-format/java-code
        delete-branch: true

  checkstyle:
    name: CheckStyle Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Create CheckStyle configuration
      run: |
        mkdir -p .github/checkstyle
        cat > .github/checkstyle/checkstyle.xml << 'EOF'
        <?xml version="1.0"?>
        <!DOCTYPE module PUBLIC
          "-//Checkstyle//DTD Checkstyle Configuration 1.3//EN"
          "https://checkstyle.org/dtds/configuration_1_3.dtd">
        <module name="Checker">
          <property name="charset" value="UTF-8"/>
          <property name="severity" value="warning"/>
          <property name="fileExtensions" value="java, properties, xml"/>
          
          <module name="TreeWalker">
            <!-- Naming Conventions -->
            <module name="ConstantName"/>
            <module name="LocalFinalVariableName"/>
            <module name="LocalVariableName"/>
            <module name="MemberName"/>
            <module name="MethodName"/>
            <module name="PackageName"/>
            <module name="ParameterName"/>
            <module name="StaticVariableName"/>
            <module name="TypeName"/>
            
            <!-- Imports -->
            <module name="AvoidStarImport"/>
            <module name="IllegalImport"/>
            <module name="RedundantImport"/>
            <module name="UnusedImports"/>
            
            <!-- Size Violations -->
            <module name="LineLength">
              <property name="max" value="120"/>
            </module>
            <module name="MethodLength"/>
            <module name="ParameterNumber"/>
            
            <!-- Whitespace -->
            <module name="EmptyForIteratorPad"/>
            <module name="GenericWhitespace"/>
            <module name="MethodParamPad"/>
            <module name="NoWhitespaceAfter"/>
            <module name="NoWhitespaceBefore"/>
            <module name="ParenPad"/>
            <module name="TypecastParenPad"/>
            <module name="WhitespaceAfter"/>
            <module name="WhitespaceAround"/>
            
            <!-- Modifiers -->
            <module name="ModifierOrder"/>
            <module name="RedundantModifier"/>
            
            <!-- Blocks -->
            <module name="AvoidNestedBlocks"/>
            <module name="EmptyBlock"/>
            <module name="LeftCurly"/>
            <module name="NeedBraces"/>
            <module name="RightCurly"/>
            
            <!-- Common Coding Problems -->
            <module name="EmptyStatement"/>
            <module name="EqualsHashCode"/>
            <module name="IllegalInstantiation"/>
            <module name="InnerAssignment"/>
            <module name="MissingSwitchDefault"/>
            <module name="SimplifyBooleanExpression"/>
            <module name="SimplifyBooleanReturn"/>
            
            <!-- Class Design -->
            <module name="FinalClass"/>
            <module name="HideUtilityClassConstructor"/>
            <module name="InterfaceIsType"/>
            <module name="VisibilityModifier"/>
            
            <!-- Miscellaneous -->
            <module name="ArrayTypeStyle"/>
            <module name="FinalParameters"/>
            <module name="TodoComment"/>
            <module name="UpperEll"/>
          </module>
        </module>
        EOF

    - name: Run CheckStyle
      run: |
        # Download CheckStyle (Java 8 compatible version)
        wget -O checkstyle.jar https://github.com/checkstyle/checkstyle/releases/download/checkstyle-8.45.1/checkstyle-8.45.1-all.jar
        
        # Run CheckStyle on all Java files
        find . -name "*.java" -not -path "./target/*" -not -path "./.m2/*" > java-files.txt
        
        if [ -s java-files.txt ]; then
          echo "Running CheckStyle validation..."
          java -jar checkstyle.jar -c .github/checkstyle/checkstyle.xml $(cat java-files.txt) | tee checkstyle-report.txt
          
          # Check if there are any violations
          if grep -q "\[ERROR\]" checkstyle-report.txt; then
            echo "‚ùå CheckStyle violations found!"
            exit 1
          else
            echo "‚úÖ CheckStyle validation passed"
          fi
        else
          echo "No Java files found to check"
        fi

    - name: Upload CheckStyle report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: checkstyle-report
        path: |
          checkstyle-report.txt
          .github/checkstyle/checkstyle.xml
        retention-days: 7

  format-summary:
    name: Code Format Summary
    runs-on: ubuntu-latest
    needs: [format-check, spotless-check, checkstyle]
    if: always()

    steps:
    - name: Download all format reports
      uses: actions/download-artifact@v4

    - name: Generate format summary
      run: |
        echo "# Code Format Validation Summary" > format-summary.md
        echo "" >> format-summary.md
        echo "Generated on: $(date)" >> format-summary.md
        echo "" >> format-summary.md
        
        # Google Java Format Summary
        echo "## Google Java Format Check" >> format-summary.md
        if [ -f google-java-format-report/format-check-report.md ]; then
          if grep -q "‚úÖ.*All files are properly formatted" google-java-format-report/format-check-report.md; then
            echo "‚úÖ **Status**: All files properly formatted" >> format-summary.md
          elif grep -q "‚ùå.*Some files need formatting" google-java-format-report/format-check-report.md; then
            echo "‚ùå **Status**: Files need formatting" >> format-summary.md
          else
            echo "‚ö†Ô∏è **Status**: Check completed with warnings" >> format-summary.md
          fi
        else
          echo "‚ùå **Status**: Google Java Format check failed" >> format-summary.md
        fi
        echo "" >> format-summary.md
        
        # Spotless Summary
        echo "## Spotless Format Check" >> format-summary.md
        if [ -f spotless-report/spotless-report.md ]; then
          if grep -q "‚úÖ.*All files are properly formatted" spotless-report/spotless-report.md; then
            echo "‚úÖ **Status**: All files properly formatted" >> format-summary.md
          elif grep -q "‚ö†Ô∏è.*Some files need formatting" spotless-report/spotless-report.md; then
            echo "‚ö†Ô∏è **Status**: Files need formatting" >> format-summary.md
          else
            echo "‚ÑπÔ∏è **Status**: Spotless check completed" >> format-summary.md
          fi
        else
          echo "‚ö†Ô∏è **Status**: Spotless check skipped or failed" >> format-summary.md
        fi
        echo "" >> format-summary.md
        
        # CheckStyle Summary
        echo "## CheckStyle Validation" >> format-summary.md
        if [ -f checkstyle-report/checkstyle-report.txt ]; then
          if grep -q "\[ERROR\]" checkstyle-report/checkstyle-report.txt; then
            ERROR_COUNT=$(grep -c "\[ERROR\]" checkstyle-report/checkstyle-report.txt || echo "0")
            echo "‚ùå **Status**: $ERROR_COUNT CheckStyle violations found" >> format-summary.md
          else
            echo "‚úÖ **Status**: No CheckStyle violations" >> format-summary.md
          fi
        else
          echo "‚ö†Ô∏è **Status**: CheckStyle validation failed or skipped" >> format-summary.md
        fi
        echo "" >> format-summary.md
        
        # Recommendations
        echo "## Recommendations" >> format-summary.md
        echo "" >> format-summary.md
        echo "1. **Format Issues**: Run \`git commit -m 'fix: formatting [auto-format]'\` to trigger auto-formatting" >> format-summary.md
        echo "2. **IDE Setup**: Configure your IDE to use Google Java Format" >> format-summary.md
        echo "3. **Pre-commit**: Consider adding format checks to pre-commit hooks" >> format-summary.md
        echo "4. **CI Integration**: All format checks should pass before merging" >> format-summary.md
        echo "" >> format-summary.md
        
        # Detailed Reports Reference
        echo "## Detailed Reports" >> format-summary.md
        echo "" >> format-summary.md
        echo "For detailed findings, check these artifacts:" >> format-summary.md
        echo "- \`google-java-format-report\`: Google Java Format analysis" >> format-summary.md
        echo "- \`spotless-report\`: Spotless format check results" >> format-summary.md
        echo "- \`checkstyle-report\`: CheckStyle validation details" >> format-summary.md

    - name: Upload format summary
      uses: actions/upload-artifact@v4
      with:
        name: format-validation-summary
        path: format-summary.md
        retention-days: 30
